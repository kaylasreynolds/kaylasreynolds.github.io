<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Client Management</title>
<style>
  :root{
    --grad1:#4c51bf; --grad2:#553c9a;
    --ok:#2f855a;--ok2:#276749;
    --danger:#c53030;--danger2:#97266d;
    --text:#222;--muted:#555;--muted2:#888;
    --card:rgba(255,255,255,.95);--ring:#d6d6d6;
    --shadow:0 10px 30px rgba(0,0,0,.12);
  }
  *{box-sizing:border-box}html,body{height:100%}
  body{margin:0;font-family:system-ui, -apple-system, "Segoe UI", Inter, Roboto, Ubuntu, sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);color:var(--text)}
  .container{max-width:1200px;margin:auto;padding:20px}
  header{background:var(--card);backdrop-filter:blur(10px);border-radius:20px;padding:24px;margin-bottom:20px;box-shadow:var(--shadow)}
  h1{margin:0 0 6px;background:linear-gradient(135deg,var(--grad1),var(--grad2));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:16px 0}
  .tab{padding:10px 18px;border:0;border-radius:999px;background:#ffffff;cursor:pointer;font-weight:700;box-shadow:0 4px 15px rgba(0,0,0,.1)}
  .tab.active,[aria-selected="true"]{color:#fff;background:linear-gradient(135deg,var(--grad1),var(--grad2))}
  .stats-grid{display:grid;grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));gap:20px;margin-bottom:30px;align-items:stretch}
  .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:20px}
  .stat-number{font-size:2rem;font-weight:800;background:linear-gradient(135deg,var(--grad1),var(--grad2));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
  .muted{color:var(--muted);font-size:.95rem}
  .search{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;margin-bottom:12px}
  .search .row{display:flex;gap:10px}
  .search input,.search select{width:100%;padding:12px 14px;border-radius:12px;border:2px solid var(--ring);font-size:1rem}
  .list{display:grid;gap:12px}
  .client-item,.interaction-item{background:#fff;border-radius:12px;padding:16px;border-left:4px solid transparent;box-shadow:0 2px 10px rgba(0,0,0,.06)}
  .client-item:hover,.interaction-item:hover{transform:translateY(-1px);transition:.2s;box-shadow:0 6px 16px rgba(0,0,0,.1);border-left-color:var(--grad1)}
  .client-header{display:flex;justify-content:space-between;gap:12px}
  .client-name{font-weight:800}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:.75rem;font-weight:700}
  .status-introductory{background:#e6f0ff;color:#1a365d}
  .status-first-appointment{background:#fffbea;color:#744210}
  .status-established{background:#c6f6d5;color:#22543d}
  .badge-sale{background:linear-gradient(135deg,var(--ok),var(--ok2));color:#fff;padding:4px 10px;border-radius:999px;font-size:.75rem;font-weight:800;margin-left:8px}
  .buttons{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .btn{padding:10px 16px;border:0;border-radius:999px;font-weight:800;cursor:pointer}
  .btn.primary{color:#fff;background:linear-gradient(135deg,var(--grad1),var(--grad2))}
  .btn.ghost{background:#e5e5e5}
  .btn.danger{color:#fff;background:linear-gradient(135deg,var(--danger),var(--danger2))}
  .btn.small{padding:6px 10px;font-size:.85rem}
  .tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
  .tag{background:#eef;color:#333;padding:4px 10px;border-radius:999px;font-size:.75rem;font-weight:700}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:10}
  .modal.active{display:flex}
  .panel{background:#fff;border-radius:16px;width:min(720px,92vw);max-height:90vh;overflow:auto;padding:20px}
  .panel header{display:flex;align-items:center;justify-content:space-between;margin:0 0 10px}
  .x{background:transparent;border:0;font-size:22px;cursor:pointer;color:var(--muted2)}
  label{display:block;font-weight:700;margin:12px 0 6px}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:2px solid var(--ring);font-size:1rem}
  textarea{min-height:90px;resize:vertical}
  .row-cols{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
  .empty-state{text-align:center;color:var(--muted2);padding:28px}
  .tasks-block{display:grid;gap:16px}
  .todo-controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
  .todo-list{display:grid;gap:10px}
  .todo-item{background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:12px;border-left:4px solid #4c51bf;display:flex;flex-direction:column}
  .todo-title{font-weight:800}
  .todo-meta{font-size:.85rem;color:var(--muted)}
  .todo-clients{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .todo-client{background:#eef;border-radius:999px;padding:2px 8px;font-size:.8rem}
  .followup-sections{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
  .followup-card{background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);border-left:4px solid transparent;padding:12px}
  .pill-911{background:#ffe2e2;color:#7a0613}
  @media (max-width:900px){.container{padding:12px}}
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Client Management</h1>
      <div class="toolbar">
        <button id="exportBtn" class="btn ghost">‚¨áÔ∏è Export JSON</button>
        <button id="importBtn" class="btn ghost">‚¨ÜÔ∏è Import JSON</button>
        <input id="importFile" type="file" accept="application/json" style="display:none">
        <button id="importCsvBtn" class="btn ghost">‚¨ÜÔ∏è Import CSV</button>
        <input id="importCsvFile" type="file" accept=".csv,text/csv" style="display:none">
        <button id="clearBtn" class="btn danger">üóëÔ∏è Clear Data</button>
      </div>
    </header>

    <div class="tabs" role="tablist">
      <button class="tab active" data-tab="dashboard">üìä Dashboard</button>
      <button class="tab" data-tab="clients">üë• Clients</button>
      <button class="tab" data-tab="interactions">üí¨ Interactions</button>
      <button class="tab" data-tab="sales">üí∞ Sales</button>
      <button class="tab" data-tab="tasks">üìÖ Tasks</button>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="tab-content">
      <div class="stats-grid">
        <div class="card"><div class="stat-number" id="totalClients">0</div><div class="muted">Total Clients</div></div>
        <div class="card"><div class="stat-number" id="totalInteractions">0</div><div class="muted">Total Interactions</div></div>
        <div class="card"><div class="stat-number" id="activeThisMonth">0</div><div class="muted">Active This Month</div></div>
        <div class="card"><div class="stat-number" id="totalSales">$0.00</div><div class="muted">Total Sales</div></div>
      </div>
    </div>

    <!-- Clients -->
    <div id="clients" class="tab-content" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px">
          <h2 style="margin:0">Client Management</h2>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="openClientBtn" class="btn primary">+ Add New Client</button>
            <button id="createTodoFromClientsBtn" class="btn ghost">üìù Create To‚ÄëDo from Filter</button>
          </div>
        </div>

        <div class="search">
          <input type="text" id="clientSearch" placeholder="Search clients by name, email, phone, style, brand, color...">
          <div class="row">
            <select id="clientSort">
              <option value="createdAt_desc">Sort: Recently Added</option>
              <option value="lastInteraction_desc">Sort: Last Interaction (Newest‚ÜíOldest)</option>
              <option value="lastInteraction_asc">Sort: Last Interaction (Oldest‚ÜíNewest)</option>
              <option value="lastName_asc">Sort: Last Name (A‚ÜíZ)</option>
              <option value="lastName_desc">Sort: Last Name (Z‚ÜíA)</option>
            </select>
          </div>
        </div>

        <!-- Filters -->
        <div class="filters">
          <div class="row" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <strong class="muted">Style:</strong>
            <label class="chk"><input type="checkbox" class="style-filter" value="Bohemian"> Bohemian</label>
            <label class="chk"><input type="checkbox" class="style-filter" value="Classic"> Classic</label>
            <label class="chk"><input type="checkbox" class="style-filter" value="Edgy"> Edgy</label>
            <label class="chk"><input type="checkbox" class="style-filter" value="Casual"> Casual</label>
            <label class="chk"><input type="checkbox" class="style-filter" value="Vintage"> Vintage</label>
            <label class="chk"><input type="checkbox" class="style-filter" value="Trendy"> Trendy</label>
            <select id="styleMatch" title="Match mode">
              <option value="any">Match any selected</option>
              <option value="all">Match all selected</option>
            </select>
            <button class="btn ghost" id="clearFiltersBtn" type="button">Clear</button>
          </div>

          <!-- Last Interaction -->
          <div class="row" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:6px">
            <strong class="muted">Last Interaction:</strong>
            <select id="lastInteractionFilter" title="Last Interaction Filter">
              <option value="any">Any time</option>
              <option value="never">Never</option>
              <option value="gt7">More than 7 days</option>
              <option value="gt14">More than 14 days</option>
              <option value="gt30">More than 30 days</option>
              <option value="gt60">More than 60 days</option>
              <option value="gt90">More than 90 days</option>
              <option value="gt180">More than 180 days</option>
              <option value="gt365">More than 365 days</option>
              <option value="before">Before date‚Ä¶</option>
              <option value="after">After date‚Ä¶</option>
              <option value="between">Between dates‚Ä¶</option>
            </select>
            <input type="date" id="lastInteractionStart" style="display:none" aria-label="Start date">
            <input type="date" id="lastInteractionEnd"   style="display:none" aria-label="End date">
            <button id="resetLastInteraction" class="btn small ghost" type="button">Reset</button>
          </div>
        </div>

        <div class="list" id="clientList">
          <div class="empty-state">
            <div style="font-size:42px;opacity:.6">üë•</div>
            <p>No clients yet. Add your first client!</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Interactions -->
    <div id="interactions" class="tab-content" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px">
          <h2 style="margin:0">Interaction Tracking</h2>
          <button id="openInteractionBtn" class="btn primary">+ Log Interaction</button>
        </div>
        <div class="search"><input type="text" id="interactionSearch" placeholder="Search interactions..."></div>
        <div class="list" id="interactionList">
          <div class="empty-state"><div style="font-size:42px;opacity:.6">üí¨</div><p>No interactions logged yet</p></div>
        </div>
      </div>
    </div>

    <!-- Sales -->
    <div id="sales" class="tab-content" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px">
          <h2 style="margin:0">Sales Tracking</h2>
          <button id="openSaleBtn" class="btn primary">+ Record Sale</button>
        </div>
        <div class="list" id="salesList">
          <div class="empty-state"><div style="font-size:42px;opacity:.6">üí∞</div><p>No sales data available</p></div>
        </div>
      </div>
    </div>

    <!-- Tasks -->
    <div id="tasks" class="tab-content" style="display:none">
      <div class="card tasks-block">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <h2 style="margin:0">Tasks</h2>
          <button id="openTodoBtn" class="btn primary">üìù New To‚ÄëDo</button>
        </div>

        <div>
          <div class="todo-controls">
            <div class="left">
              <strong>To‚ÄëDo</strong>
              <span class="muted" id="todoCount">0 items</span>
            </div>
            <div class="right" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <label class="muted" style="font-weight:700">Filter</label>
              <select id="todoFilterStatus" title="Status Filter">
                <option value="all">All</option><option value="open">Open</option><option value="done">Done</option>
              </select>
              <select id="todoFilterDue" title="Due Filter">
                <option value="any">Any Due</option><option value="today">Due Today</option><option value="week">Due This Week</option><option value="overdue">Overdue</option>
              </select>
              <select id="todoFilterClient" title="Client Filter"><option value="all">All Clients</option></select>
              <label for="todoSort" class="muted" style="font-weight:700">Sort</label>
              <select id="todoSort">
                <option value="date_asc">Due Date (Soonest)</option>
                <option value="date_desc">Due Date (Latest)</option>
                <option value="created_desc">Recently Added</option>
                <option value="created_asc">Oldest Added</option>
                <option value="title_asc">Title (A‚ÜíZ)</option>
                <option value="status">Status (Open‚ÜíDone)</option>
              </select>
            </div>
          </div>
          <div class="todo-list" id="todoList">
            <div class="empty-state"><div style="font-size:42px;opacity:.6">üìù</div><p>No to‚Äëdos yet</p></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Client Modal -->
  <div id="clientModal" class="modal">
    <div class="panel">
      <header><h3 id="clientModalTitle" style="margin:0">Add New Client</h3><button class="x" data-close-modal>√ó</button></header>
      <form id="clientForm">
        <div class="row-cols">
          <div><label>First Name *</label><input type="text" id="clientFirstName" required></div>
          <div><label>Last Name *</label><input type="text" id="clientLastName" required></div>
        </div>
        <div class="row-cols">
          <div><label>Email</label><input type="email" id="clientEmail"></div>
          <div><label>Phone</label><input type="tel" id="clientPhone"></div>
        </div>
        <div class="row-cols">
          <div>
            <label>Style Vibe (choose one or more)</label>
            <select id="clientStyles" multiple size="6">
              <option>Bohemian</option><option>Classic</option><option>Edgy</option>
              <option>Casual</option><option>Vintage</option><option>Trendy</option>
            </select>
          </div>
          <div>
            <label>Initial Sales Amount</label>
            <input type="number" id="clientInitialSales" min="0" step="0.01" placeholder="0.00">
          </div>
        </div>
        <div><label>Notes</label><textarea id="clientNotes" placeholder="Add any notes..."></textarea></div>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
          <button type="button" class="btn ghost" data-close-modal>Cancel</button>
          <button type="submit" class="btn primary">Save Client</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Interaction Modal -->
  <div id="interactionModal" class="modal">
    <div class="panel">
      <header><h3 id="interactionModalTitle" style="margin:0">Log Interaction</h3><button class="x" data-close-modal>√ó</button></header>
      <form id="interactionForm">
        <div>
          <label>Client *</label>
          <select id="interactionClient" required><option value="">Select client...</option></select>
        </div>
        <div class="row-cols">
          <div>
            <label>Type *</label>
            <select id="interactionType" required>
              <option>Call</option><option>Email</option><option>Text</option><option>In-person</option>
            </select>
          </div>
          <div><label>Date *</label><input type="date" id="interactionDate" required></div>
        </div>
        <div><label>Notes</label><textarea id="interactionNotes" placeholder="Describe the interaction..."></textarea></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button type="button" class="btn ghost" data-close-modal>Cancel</button>
          <button type="submit" class="btn primary">Save Interaction</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Sale Modal -->
  <div id="saleModal" class="modal">
    <div class="panel">
      <header><h3 id="saleModalTitle" style="margin:0">Record Sale</h3><button class="x" data-close-modal>√ó</button></header>
      <form id="saleForm">
        <div>
          <label>Client *</label>
          <select id="saleClient" required><option value="">Select client...</option></select>
        </div>
        <div class="row-cols">
          <div><label>Amount *</label><input type="number" id="saleAmount" min="0" step="0.01" required placeholder="0.00"></div>
          <div><label>Date *</label><input type="date" id="saleDate" required></div>
        </div>
        <div><label>Description</label><input type="text" id="saleDescription" placeholder="What was sold?"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button type="button" class="btn ghost" data-close-modal>Cancel</button>
          <button type="submit" class="btn primary">Save Sale</button>
        </div>
      </form>
    </div>
  </div>

  <!-- To‚ÄëDo Modal -->
  <div id="todoModal" class="modal">
    <div class="panel">
      <header><h3 id="todoModalTitle" style="margin:0">New To‚ÄëDo</h3><button class="x" data-close-modal>√ó</button></header>
      <form id="todoForm">
        <input type="hidden" id="todoEditingId">
        <div><label>Title *</label><input id="todoTitle" required placeholder="e.g., Send lookbook"></div>
        <div class="row-cols">
          <div><label>Due Date *</label><input type="date" id="todoDate" required></div>
          <div>
            <label>Status</label>
            <select id="todoStatus"><option value="open">Open</option><option value="done">Done</option></select>
          </div>
        </div>

        <!-- Quick select by last interaction -->
        <div class="row-cols">
          <div>
            <label>Quick Select by Last Interaction</label>
            <div class="filters-row" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <select id="todoLastIntFilter" title="Quick Select">
                <option value="none">Choose‚Ä¶</option>
                <option value="never">Never</option>
                <option value="gt7">More than 7 days</option>
                <option value="gt14">More than 14 days</option>
                <option value="gt30">More than 30 days</option>
                <option value="gt60">More than 60 days</option>
                <option value="gt90">More than 90 days</option>
                <option value="gt180">More than 180 days</option>
                <option value="gt365">More than 365 days</option>
                <option value="before">Before date‚Ä¶</option>
                <option value="after">After date‚Ä¶</option>
                <option value="between">Between dates‚Ä¶</option>
              </select>
              <input type="date" id="todoLastIntStart" style="display:none" aria-label="Start date">
              <input type="date" id="todoLastIntEnd"   style="display:none" aria-label="End date">
              <button id="todoSelectByLastInt" type="button" class="btn ghost">Select Clients</button>
            </div>
            <div class="muted" style="font-size:.85rem;margin-top:6px">Tip: pick clients by ‚Äúlast contacted‚Äù right here.</div>
          </div>
        </div>

        <div>
          <label>Clients (multi‚Äëselect)</label>
          <select id="todoClients" multiple size="8"></select>
          <div class="muted" style="font-size:.85rem;margin-top:6px">Selecting multiple clients will create separate tasks for each client.</div>
        </div>
        <div><label>Notes</label><textarea id="todoNotes" placeholder="Details for this task..."></textarea></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button type="button" class="btn ghost" data-close-modal>Cancel</button>
          <button type="submit" class="btn primary">Save To‚ÄëDo</button>
        </div>
      </form>
    </div>
  </div>

<script>
/* =========================
   Utilities & Globals
========================= */
const fmtUSD = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 });
const $  = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => [...r.querySelectorAll(s)];
const escapeHTML = (str) => String(str ?? '')
  .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
  .replace(/"/g,'&quot;').replace(/'/g,'&#039;');

const VALID_STATUSES = ["Introductory","First Appointment","Established"];
const statusSlug = s => String(s||"").toLowerCase().replace(/\s+/g,'-');

const ALLOWED_STYLES = ["Bohemian","Classic","Edgy","Casual","Vintage","Trendy"];
const getSelectedValues = (sel) => [...sel.options].filter(o=>o.selected).map(o=>o.value);
const normalizeStyles = (v) => Array.isArray(v) ? v.filter(x=>ALLOWED_STYLES.includes(x))
  : (typeof v==='string' && v.trim()
     ? v.split(/[;,]/).map(s=>s.trim()).filter(x=>ALLOWED_STYLES.includes(x))
     : []);
const parseCSV = (str) => String(str || '')
  .split(/[;,]/).map(s => s.trim()).filter(Boolean);

/* =========================
   Data
========================= */
let clients = [];
let interactions = [];
let sales = [];
let followUps = [];
let todos = [];

let editingClientId = null;
let editingInteractionId = null;
let editingSaleId = null;
let lastClientFilterResult = [];

/* =========================
   Storage
========================= */
function saveData(){
  localStorage.setItem('crm_clients', JSON.stringify(clients));
  localStorage.setItem('crm_interactions', JSON.stringify(interactions));
  localStorage.setItem('crm_sales', JSON.stringify(sales));
  localStorage.setItem('crm_followups', JSON.stringify(followUps));
  localStorage.setItem('crm_todos', JSON.stringify(todos));
}
function loadData(){
  try{
    clients = JSON.parse(localStorage.getItem('crm_clients') || '[]');
    interactions = JSON.parse(localStorage.getItem('crm_interactions') || '[]');
    sales = JSON.parse(localStorage.getItem('crm_sales') || '[]');
    followUps = JSON.parse(localStorage.getItem('crm_followups') || '[]');
    todos = JSON.parse(localStorage.getItem('crm_todos') || '[]');

    let migrated = false;

    // normalize dates
    interactions.forEach(i=>{ if(i.date && i.date.length>10){ i.date=i.date.slice(0,10); migrated=true; }});
    followUps.forEach(f=>{ if(f.completed===undefined){ f.completed=false; migrated=true; }});
    todos.forEach(t=>{ if(!t.status){ t.status='open'; migrated=true; }});

    // üîß MIGRATION: Split any existing To‚ÄëDos that have multiple clients into one per client
    if (Array.isArray(todos) && todos.length){
      const split = [];
      let changed = false;
      for (const t of todos){
        const ids = Array.isArray(t.clientIds) ? t.clientIds.filter(Boolean) : [];
        if (ids.length > 1){
          ids.forEach((cid) => {
            split.push({
              ...t,
              id: (t.id || Date.now().toString()) + '-' + cid,
              clientIds: [cid]
            });
          });
          changed = true;
        } else {
          split.push(t);
        }
      }
      if (changed){ todos = split; migrated = true; }
    }

    if (migrated) saveData();
  }catch(e){
    console.warn('load error',e); clients=[]; interactions=[]; sales=[]; followUps=[]; todos=[];
  }
}

/* =========================
   Startup
========================= */
document.addEventListener('DOMContentLoaded', ()=>{
  loadData();
  renderAll();

  const today = new Date().toISOString().slice(0,10);
  ['interactionDate','saleDate','todoDate'].forEach(id=>{ const el=$('#'+id); if(el) el.value=today; });

  // close modals
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeAllModals(); });
  document.addEventListener('click', e=>{
    const m = e.target.closest('.modal');
    if (m && !e.target.closest('.panel')) m.classList.remove('active');
  });
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-close-modal]'); if(!btn) return;
    const m = btn.closest('.modal'); if (m){ m.classList.remove('active'); m.querySelector('form')?.reset(); }
  });

  // header
  $('#exportBtn')?.addEventListener('click', exportData);
  const importBtn=$('#importBtn'), importFile=$('#importFile');
  if(importBtn && importFile){
    importBtn.addEventListener('click',()=>importFile.click());
    importFile.addEventListener('change',e=>{ const f=e.target.files[0]; if(f) importData(f); importFile.value=''; });
  }
  // CSV import
  const importCsvBtn=$('#importCsvBtn'), importCsvFile=$('#importCsvFile');
  if(importCsvBtn && importCsvFile){
    importCsvBtn.addEventListener('click',()=>importCsvFile.click());
    importCsvFile.addEventListener('change',e=>{ const f=e.target.files[0]; if(f) importClientsFromCsvFile(f); importCsvFile.value=''; });
  }

  $('#clearBtn')?.addEventListener('click', ()=>{
    if(confirm('Clear ALL data? This cannot be undone.')){
      clients=[]; interactions=[]; sales=[]; followUps=[]; todos=[];
      saveData(); renderAll();
    }
  });

  // tabs
  $$('.tab').forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.tab)));

  // clients page
  $$('.style-filter').forEach(cb=>cb.addEventListener('change', applyFiltersAndSort));
  $('#styleMatch')?.addEventListener('change', applyFiltersAndSort);
  $('#clearFiltersBtn')?.addEventListener('click', ()=>{ $$('.style-filter').forEach(cb=>cb.checked=false); $('#styleMatch').value='any'; applyFiltersAndSort(); });
  $('#clientSearch')?.addEventListener('input', applyFiltersAndSort);
  $('#clientSort')?.addEventListener('change', applyFiltersAndSort);

  // last interaction filter
  $('#lastInteractionFilter')?.addEventListener('change', ()=>{
    const v = $('#lastInteractionFilter').value;
    $('#lastInteractionStart').style.display = (v==='before'||v==='after'||v==='between') ? '' : 'none';
    $('#lastInteractionEnd').style.display   = (v==='between') ? '' : 'none';
    applyFiltersAndSort();
  });
  $('#lastInteractionStart')?.addEventListener('change', applyFiltersAndSort);
  $('#lastInteractionEnd')?.addEventListener('change', applyFiltersAndSort);
  $('#resetLastInteraction')?.addEventListener('click', ()=>{
    $('#lastInteractionFilter').value='any';
    $('#lastInteractionStart').value='';
    $('#lastInteractionEnd').value='';
    $('#lastInteractionStart').style.display='none';
    $('#lastInteractionEnd').style.display='none';
    applyFiltersAndSort();
  });

  $('#openClientBtn')?.addEventListener('click', ()=>openClientModal());
  $('#createTodoFromClientsBtn')?.addEventListener('click', ()=>openTodoModal(lastClientFilterResult.map(c=>c.id)));
  $('#clientList')?.addEventListener('click', e=>{
    const btn = e.target.closest('button[data-action]'); if(!btn) return;
    const id = btn.getAttribute('data-id'); const action=btn.getAttribute('data-action');
    if (action==='view') openClientView(id);
    if (action==='edit') openClientModal(id);
    if (action==='delete') deleteClient(id);
  });

  // interactions
  $('#openInteractionBtn')?.addEventListener('click', ()=>openInteractionModal());
  $('#interactionSearch')?.addEventListener('input', searchInteractions);
  $('#interactionList')?.addEventListener('click', e=>{
    const del = e.target.closest('[data-action="delete-interaction"]');
    const edit = e.target.closest('[data-action="edit-interaction"]');
    if (del) return deleteInteraction(del.dataset.id);
    if (edit) return openInteractionModal(edit.dataset.id);
  });

  // sales
  $('#openSaleBtn')?.addEventListener('click', ()=>openSaleModal());
  $('#salesList')?.addEventListener('click', e=>{
    const edit=e.target.closest('[data-action="edit-sale"]');
    const del=e.target.closest('[data-action="delete-sale"]');
    if (edit) return openSaleModal(edit.dataset.id);
    if (del) return deleteSale(del.dataset.id);
  });

  // tasks
  $('#openTodoBtn')?.addEventListener('click', ()=>openTodoModal());
  $('#todoSort')?.addEventListener('change', renderTodos);
  $('#todoFilterStatus')?.addEventListener('change', renderTodos);
  $('#todoFilterDue')?.addEventListener('change', renderTodos);
  $('#todoFilterClient')?.addEventListener('change', renderTodos);

  // quick select by last interaction in To‚ÄëDo modal
  $('#todoLastIntFilter')?.addEventListener('change', ()=>{
    const v = $('#todoLastIntFilter').value;
    $('#todoLastIntStart').style.display = (v==='before'||v==='after'||v==='between')?'':'none';
    $('#todoLastIntEnd').style.display   = (v==='between')?'':'none';
  });
  $('#todoSelectByLastInt')?.addEventListener('click', ()=>{
    const v  = $('#todoLastIntFilter').value;
    if (v==='none') return;
    const s  = $('#todoLastIntStart').value || '';
    const e  = $('#todoLastIntEnd').value   || '';
    const matchIds = clients.filter(c => matchesLastInteractionRule(c.id, v, s, e)).map(c => c.id);
    const sel = $('#todoClients'); if (!sel) return;
    [...sel.options].forEach(o => { o.selected = matchIds.includes(o.value); });
  });
});

function renderAll(){ renderClients(); renderInteractions(); renderSalesView(); renderTodos(); updateDashboard(); }
function closeAllModals(){ $$('.modal.active').forEach(m=>m.classList.remove('active')); }
function switchTab(tab){
  $$('.tab-content').forEach(c=>c.style.display=(c.id===tab?'block':'none'));
  $$('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===tab));
  if(tab==='dashboard') updateDashboard();
  if(tab==='sales') renderSalesView();
  if(tab==='tasks'){ renderTodos(); }
}

/* =========================
   Helpers
========================= */
const fullNameOf = (c)=>`${c.firstName??''} ${c.lastName??''}`.trim();
function getActiveStyleFilters(){ return [...document.querySelectorAll('.style-filter:checked')].map(c=>c.value); }
function lastInteractionDate(clientId){
  const ds = interactions.filter(i=>i.clientId===clientId).map(i=>new Date(i.date));
  return ds.length? new Date(Math.max(...ds)) : null;
}
function daysBetween(a, b) {
  const MS = 24*60*60*1000;
  return Math.floor((Date.UTC(b.getFullYear(),b.getMonth(),b.getDate()) -
                     Date.UTC(a.getFullYear(),a.getMonth(),a.getDate())) / MS);
}
function matchesLastInteractionRule(clientId, mode, startStr, endStr){
  const li = lastInteractionDate(clientId);
  const today = new Date();
  const olderThan = (n) => (li ? daysBetween(li, today) > n : false);
  switch(mode){
    case 'any':     return true;
    case 'never':   return !li;
    case 'gt7':     return olderThan(7);
    case 'gt14':    return olderThan(14);
    case 'gt30':    return olderThan(30);
    case 'gt60':    return olderThan(60);
    case 'gt90':    return olderThan(90);
    case 'gt180':   return olderThan(180);
    case 'gt365':   return olderThan(365);
    case 'before':  return (startStr && li) ? (li < new Date(startStr)) : true;
    case 'after':   return (startStr && li) ? (li > new Date(startStr)) : true;
    case 'between': return (startStr && endStr && li) ? (li >= new Date(startStr) && li <= new Date(endStr)) : true;
    default: return true;
  }
}

/* =========================
   Clients
========================= */
function openClientModal(id=null){
  editingClientId = id;
  const m=$('#clientModal'); const form=$('#clientForm');
  if (id){
    const c=clients.find(x=>x.id===id);
    $('#clientModalTitle').textContent='Edit Client';
    $('#clientFirstName').value=c.firstName||''; $('#clientLastName').value=c.lastName||'';
    $('#clientEmail').value=c.email||''; $('#clientPhone').value=c.phone||'';
    [...$('#clientStyles').options].forEach(o=>o.selected=(c.styles||[]).includes(o.value));
    $('#clientInitialSales').value=c.initialSales??'';
    $('#clientNotes').value=c.notes||'';
  } else {
    $('#clientModalTitle').textContent='Add New Client'; form.reset();
    [...$('#clientStyles').options].forEach(o=>o.selected=false);
  }
  m.classList.add('active');
}
$('#clientForm')?.addEventListener('submit', e=>{
  e.preventDefault();
  const firstName=$('#clientFirstName').value.trim(), lastName=$('#clientLastName').value.trim();
  if(!firstName||!lastName) return alert('First and last names are required.');
  const data={
    firstName,lastName,
    email:$('#clientEmail').value.trim(), phone:$('#clientPhone').value.trim(),
    styles: normalizeStyles(getSelectedValues($('#clientStyles'))),
    initialSales: parseFloat($('#clientInitialSales').value)||0,
    notes: $('#clientNotes').value.trim(),
    createdAt: new Date().toISOString()
  };
  if (editingClientId){
    const i=clients.findIndex(c=>c.id===editingClientId);
    clients[i] = { ...clients[i], ...data, createdAt: clients[i].createdAt||data.createdAt };
  } else { data.id=Date.now().toString(); clients.push(data); }
  saveData(); $('#clientModal').classList.remove('active'); renderClients(); updateDashboard(); populateTodoClientFilter();
});
function deleteClient(id){
  if(!confirm('Delete this client and related items?')) return;
  clients=clients.filter(c=>c.id!==id);
  interactions=interactions.filter(i=>i.clientId!==id);
  sales=sales.filter(s=>s.clientId!==id);
  followUps=followUps.filter(f=>f.clientId!==id);
  todos=todos.filter(t=>!t.clientIds.includes(id));
  saveData(); renderAll(); populateTodoClientFilter();
}
function totalSpentFor(clientId){
  const c=clients.find(x=>x.id===clientId);
  const extra=sales.filter(s=>s.clientId===clientId).reduce((sum,s)=>sum+(Number(s.amount)||0),0);
  return (Number(c?.initialSales)||0)+extra;
}
function sortClients(arr, mode){
  const byLast=(a,b)=>(a.lastName||'').localeCompare(b.lastName||'');
  const byCreatedDesc=(a,b)=>new Date(b.createdAt)-new Date(a.createdAt);
  switch(mode){
    case 'lastInteraction_desc': return arr.sort((a,b)=>{const da=lastInteractionDate(a.id),db=lastInteractionDate(b.id); if(da&&db) return db-da; if(da&&!db) return -1; if(!da&&db) return 1; return byLast(a,b);});
    case 'lastInteraction_asc':  return arr.sort((a,b)=>{const da=lastInteractionDate(a.id),db=lastInteractionDate(b.id); if(da&&db) return da-db; if(da&&!db) return -1; if(!da&&db) return 1; return byLast(a,b);});
    case 'lastName_asc': return arr.sort(byLast);
    case 'lastName_desc':return arr.sort((a,b)=>byLast(b,a));
    case 'createdAt_desc':
    default:             return arr.sort(byCreatedDesc);
  }
}
function applyFiltersAndSort(){
  const term = ($('#clientSearch').value||'').toLowerCase();
  const selected = getActiveStyleFilters();
  const mode = $('#styleMatch')?.value||'any';
  const liMode  = $('#lastInteractionFilter')?.value || 'any';
  const liStart = $('#lastInteractionStart')?.value || '';
  const liEnd   = $('#lastInteractionEnd')?.value || '';

  let list = clients.filter(c=>{
    const matchesTerm = fullNameOf(c).toLowerCase().includes(term) ||
      (c.email&&c.email.toLowerCase().includes(term)) ||
      (c.phone&&c.phone.includes(term)) ||
      (c.styles&&c.styles.some(s=>s.toLowerCase().includes(term)));
    if(!matchesTerm) return false;

    if(selected.length){
      const styles = c.styles||[];
      const styleOk = (mode==='all') ? selected.every(s=>styles.includes(s)) : selected.some(s=>styles.includes(s));
      if(!styleOk) return false;
    }
    if(!matchesLastInteractionRule(c.id, liMode, liStart, liEnd)) return false;
    return true;
  });

  list = sortClients(list, $('#clientSort').value||'createdAt_desc');
  renderClients(list);
}
function renderClients(src=clients){
  const list=$('#clientList');
  if(src.length===0){ list.innerHTML=`<div class="empty-state"><div style="font-size:42px;opacity:.6">üë•</div><p>No clients yet. Add your first client!</p></div>`; lastClientFilterResult=[]; return;}
  const sorted = sortClients([...src], $('#clientSort').value||'createdAt_desc'); lastClientFilterResult=[...sorted];
  list.innerHTML = sorted.map(c=>{
    const total=totalSpentFor(c.id); const li=lastInteractionDate(c.id);
    return `<div class="client-item">
      <div class="client-header">
        <div>
          <div class="client-name">${escapeHTML(fullNameOf(c))} ${total>0? `<span class="badge-sale">${fmtUSD.format(total)}</span>`:''}</div>
          <div class="muted" style="margin-top:4px">${c.email?`üìß ${escapeHTML(c.email)} ¬∑ `:''}${c.phone?`üì± ${escapeHTML(c.phone)}`:''}</div>
          ${(c.styles&&c.styles.length)? `<div class="tags" aria-label="Style Vibes">${c.styles.map(s=>`<span class="tag">${escapeHTML(s)}</span>`).join('')}</div>`:''}
          ${li? `<div class="muted" style="margin-top:6px;font-size:.85rem">Last Interaction: ${li.toLocaleDateString()}</div>`:''}
        </div>
        <span class="chip status-${statusSlug('Established')}">Established</span>
      </div>
      <div class="buttons">
        <button class="btn primary" data-action="view" data-id="${c.id}">View</button>
        <button class="btn ghost" data-action="edit" data-id="${c.id}">Edit</button>
        <button class="btn danger" data-action="delete" data-id="${c.id}">Delete</button>
      </div>
    </div>`;
  }).join('');
  populateTodoClientFilter();
}
function openClientView(id){
  const c=clients.find(x=>x.id===id); if(!c) return alert('Client not found');
  alert(`${fullNameOf(c)}\nEmail: ${c.email||'‚Äî'}\nPhone: ${c.phone||'‚Äî'}\nStyles: ${(c.styles||[]).join(', ')||'‚Äî'}`);
}

/* =========================
   Interactions
========================= */
function openInteractionModal(id=null){
  editingInteractionId=id;
  const sel=$('#interactionClient');
  sel.innerHTML='<option value="">Select client...</option>'+clients.map(c=>`<option value="${c.id}">${escapeHTML(fullNameOf(c))}</option>`).join('');
  if (id){
    const it=interactions.find(i=>i.id===id); if(!it) return;
    $('#interactionModalTitle').textContent='Edit Interaction';
    sel.value=it.clientId; $('#interactionType').value=it.type; $('#interactionDate').value=it.date; $('#interactionNotes').value=it.notes||'';
  } else {
    $('#interactionModalTitle').textContent='Log Interaction'; $('#interactionForm').reset(); $('#interactionDate').value=new Date().toISOString().slice(0,10);
  }
  $('#interactionModal').classList.add('active');
}
$('#interactionForm')?.addEventListener('submit', e=>{
  e.preventDefault();
  const clientId=$('#interactionClient').value; if(!clientId) return alert('Please select a client.');
  const date=$('#interactionDate').value||new Date().toISOString().slice(0,10);
  const type=$('#interactionType').value; const notes=$('#interactionNotes').value.trim();
  if (editingInteractionId){
    const i=interactions.findIndex(x=>x.id===editingInteractionId);
    if(i!==-1) interactions[i]={...interactions[i], clientId, type, date, notes};
  } else {
    interactions.push({ id:Date.now().toString(), clientId, type, date, notes, createdAt:new Date().toISOString() });
  }
  saveData(); $('#interactionModal').classList.remove('active'); renderInteractions(); updateDashboard(); renderClients();
});
function renderInteractions(src=interactions){
  const el=$('#interactionList');
  if(src.length===0){ el.innerHTML=`<div class="empty-state"><div style="font-size:42px;opacity:.6">üí¨</div><p>No interactions logged yet</p></div>`; return; }
  const sorted=[...src].sort((a,b)=>new Date(b.date)-new Date(a.date));
  el.innerHTML = sorted.map(i=>{
    const c=clients.find(x=>x.id===i.clientId); const when=new Date(i.date).toLocaleDateString([], { year:'numeric', month:'short', day:'numeric' });
    return `<div class="interaction-item">
      <div class="client-header">
        <div><div class="client-name">${escapeHTML(c?fullNameOf(c):'Unknown Client')}</div><div class="muted" style="margin-top:4px">${escapeHTML(i.type)} ‚Ä¢ ${when}</div></div>
        <div class="buttons">
          <button class="btn danger" data-action="delete-interaction" data-id="${i.id}">Delete</button>
        </div>
      </div>
      ${i.notes? `<div style="margin-top:8px">${escapeHTML(i.notes)}</div>`:''}
    </div>`;
  }).join('');
}
function deleteInteraction(id){
  if(!confirm('Delete this interaction?')) return;
  interactions=interactions.filter(i=>i.id!==id);
  saveData(); renderInteractions(); updateDashboard(); renderClients();
}
function searchInteractions(){
  const term=($('#interactionSearch').value||'').toLowerCase();
  const filtered=interactions.filter(i=>{
    const c=clients.find(x=>x.id===i.clientId);
    return (c&&fullNameOf(c).toLowerCase().includes(term)) || i.type.toLowerCase().includes(term) || (i.notes&&i.notes.toLowerCase().includes(term));
  });
  renderInteractions(filtered);
}

/* =========================
   Sales
========================= */
function openSaleModal(id=null){
  editingSaleId=id; const sel=$('#saleClient'); sel.innerHTML='<option value="">Select client...</option>'+clients.map(c=>`<option value="${c.id}">${escapeHTML(fullNameOf(c))}</option>`).join('');
  if (id){
    const s=sales.find(x=>x.id===id); if(!s) return;
    $('#saleModalTitle').textContent='Edit Sale';
    sel.value=s.clientId; $('#saleAmount').value=s.amount; $('#saleDate').value=s.date; $('#saleDescription').value=s.description||'';
  } else {
    $('#saleModalTitle').textContent='Record Sale'; $('#saleForm').reset(); $('#saleDate').value=new Date().toISOString().slice(0,10);
  }
  $('#saleModal').classList.add('active');
}
$('#saleForm')?.addEventListener('submit', e=>{
  e.preventDefault();
  const clientId=$('#saleClient').value; const amount=parseFloat($('#saleAmount').value);
  const date=$('#saleDate').value||new Date().toISOString().slice(0,10);
  const description=$('#saleDescription').value.trim();
  if(!clientId || isNaN(amount)) return alert('Client and amount are required.');
  if (editingSaleId){
    const idx=sales.findIndex(s=>s.id===editingSaleId);
    if (idx!==-1){ sales[idx]={...sales[idx], clientId, amount, date, description}; }
  } else {
    const id=Date.now().toString(); sales.push({id, clientId, amount, date, description, createdAt:new Date().toISOString()});
  }
  saveData(); $('#saleModal').classList.remove('active'); renderSalesView(); renderInteractions(); updateDashboard(); renderClients();
});
function deleteSale(id){
  if(!confirm('Delete this sale?')) return;
  sales=sales.filter(s=>s.id!==id);
  saveData(); renderSalesView(); renderInteractions(); renderClients(); updateDashboard();
}
function renderSalesView(){
  const el=$('#salesList'); const map=new Map();
  clients.forEach(c=>{
    const rows=sales.filter(s=>s.clientId===c.id);
    const total=(Number(c.initialSales)||0)+rows.reduce((sum,s)=>sum+(Number(s.amount)||0),0);
    if (total>0 || rows.length>0) map.set(c.id,{client:c,rows,total});
  });
  if (map.size===0){ el.innerHTML=`<div class="empty-state"><div style="font-size:42px;opacity:.6">üí∞</div><p>No sales data available</p></div>`; return; }
  const sorted=[...map.values()].sort((a,b)=>b.total-a.total);
  el.innerHTML = sorted.map(({client:c,rows,total})=>`
    <div class="client-item">
      <div class="client-header"><div><div class="client-name">${escapeHTML(fullNameOf(c))}</div><div class="muted" style="margin-top:4px">Total Sales: <strong style="color:#2f855a">${fmtUSD.format(total)}</strong></div></div></div>
      ${Number(c.initialSales)>0? `<div style="padding:10px 0;border-bottom:1px solid #eee;display:flex;justify-content:space-between"><div style="font-weight:600">Initial Sales</div><div style="font-weight:800;color:#2f855a">${fmtUSD.format(Number(c.initialSales)||0)}</div></div>`:''}
      ${rows.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(s=>`
        <div style="padding:10px 0;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center">
          <div><div style="font-weight:600">${escapeHTML(s.description||'Sale')}</div><div class="muted" style="font-size:.85rem">${new Date(s.date).toLocaleDateString()}</div></div>
          <div style="display:flex;align-items:center;gap:10px">
            <div style="font-weight:800;color:#2f855a">${fmtUSD.format(Number(s.amount)||0)}</div>
            <button class="btn danger" data-action="delete-sale" data-id="${s.id}">Delete</button>
          </div>
        </div>`).join('')}
    </div>`).join('');
}

/* =========================
   To‚ÄëDos (one per client)
========================= */
function openTodoModal(preselectIds = [], editId = null){
  const modal = $('#todoModal');
  const sel = $('#todoClients');
  $('#todoForm').reset();
  $('#todoEditingId').value = editId || '';
  const today = new Date().toISOString().slice(0,10);
  $('#todoDate').value = today;

  // Populate list
  sel.innerHTML = clients
    .sort((a,b)=>fullNameOf(a).localeCompare(fullNameOf(b)))
    .map(c=>`<option value="${c.id}">${escapeHTML(fullNameOf(c))}</option>`)
    .join('');

  // Use provided ids or current filtered
  const ids = (preselectIds && preselectIds.length)
    ? preselectIds
    : (lastClientFilterResult && lastClientFilterResult.length ? lastClientFilterResult.map(c=>c.id) : []);

  [...sel.options].forEach(o => { o.selected = ids.includes(o.value); });

  // Reset quick-select UI
  $('#todoLastIntFilter').value = 'none';
  $('#todoLastIntStart').value = '';
  $('#todoLastIntEnd').value = '';
  $('#todoLastIntStart').style.display = 'none';
  $('#todoLastIntEnd').style.display   = 'none';

  modal.classList.add('active');
}
$('#todoForm')?.addEventListener('submit', e=>{
  e.preventDefault();
  saveTodo();
});

// üîë The new logic: create one task per client; edit updates one & spawns extras
function saveTodo(){
  const editId = $('#todoEditingId').value || null;
  const title  = $('#todoTitle').value.trim();
  const date   = $('#todoDate').value;
  const notes  = $('#todoNotes').value.trim();
  const status = $('#todoStatus').value || 'open';
  const selectedClientIds = getSelectedValues($('#todoClients')).filter(Boolean);

  if (!title || !date) return alert('Title and due date are required.');
  if (!selectedClientIds.length) return alert('Please select at least one client.');

  const nowIso = new Date().toISOString();

  if (editId){
    // Update existing; keep 1st client on edited one, create new tasks for the rest
    const idx = todos.findIndex(t => t.id === editId);
    if (idx === -1){ alert('This to‚Äëdo no longer exists.'); return; }

    const firstId = selectedClientIds[0];
    todos[idx] = {
      ...todos[idx],
      title, date, notes, status,
      clientIds: [firstId],
      completedAt: (status === 'done') ? (todos[idx].completedAt || nowIso) : null
    };

    // Extra tasks
    const extraIds = selectedClientIds.slice(1);
    extraIds.forEach(cid => {
      todos.push({
        id: Date.now().toString() + Math.random().toString(36).slice(2,6),
        title, date, notes, status,
        clientIds: [cid],
        createdAt: nowIso,
        completedAt: (status === 'done') ? nowIso : null
      });
    });

  } else {
    // New: always one per client
    selectedClientIds.forEach(cid => {
      todos.push({
        id: Date.now().toString() + Math.random().toString(36).slice(2,6),
        title, date, notes, status,
        clientIds: [cid],
        createdAt: nowIso,
        completedAt: (status === 'done') ? nowIso : null
      });
    });
  }

  saveData();
  $('#todoModal').classList.remove('active');
  renderTodos();
}

function toggleTodo(id){
  const t=todos.find(x=>x.id===id); if(!t) return;
  if (t.status==='done'){ t.status='open'; t.completedAt=null; } else { t.status='done'; t.completedAt=new Date().toISOString(); }
  saveData(); renderTodos();
}
function deleteTodo(id){ if(!confirm('Delete this to‚Äëdo?')) return; todos=todos.filter(t=>t.id!==id); saveData(); renderTodos(); }

function populateTodoClientFilter(){
  const sel=$('#todoFilterClient'); if(!sel) return;
  const current=sel.value||'all';
  sel.innerHTML = `<option value="all">All Clients</option>` + clients.map(c=>`<option value="${c.id}">${escapeHTML(fullNameOf(c))}</option>`).join('');
  sel.value = [...sel.options].some(o=>o.value===current)? current : 'all';
}

function renderTodos(){
  populateTodoClientFilter();
  const wrap=$('#todoList');
  const sort=$('#todoSort')?.value||'date_asc';
  const fStatus=$('#todoFilterStatus')?.value||'all';
  const fDue=$('#todoFilterDue')?.value||'any';
  const fClient=$('#todoFilterClient')?.value||'all';

  let src = (fStatus==='open') ? todos.filter(t=>t.status==='open') : (fStatus==='done') ? todos.filter(t=>t.status==='done') : [...todos];

  if (fDue!=='any'){
    const today=new Date(); today.setHours(0,0,0,0);
    const endWeek=new Date(today); endWeek.setDate(today.getDate() + (7 - today.getDay() || 7));
    src = src.filter(t=>{
      if(!t.date) return false; const d=new Date(t.date); d.setHours(0,0,0,0);
      if (fDue==='today') return d.getTime()===today.getTime();
      if (fDue==='week') return d>=today && d<=endWeek;
      if (fDue==='overdue') return d<today && t.status!=='done';
      return true;
    });
  }
  if (fClient!=='all') src = src.filter(t=>t.clientIds.includes(fClient));

  const cmp = {
    date_asc:(a,b)=>(a.date||'').localeCompare(b.date||''),
    date_desc:(a,b)=>(b.date||'').localeCompare(a.date||''),
    created_desc:(a,b)=>new Date(b.createdAt)-new Date(a.createdAt),
    created_asc:(a,b)=>new Date(a.createdAt)-new Date(b.createdAt),
    title_asc:(a,b)=>a.title.localeCompare(b.title),
    status:(a,b)=> (a.status==='open'&&b.status==='done')?-1:(a.status===b.status?0:1)
  }[sort];

  src.sort(cmp);

  if (src.length===0){
    wrap.innerHTML=`<div class="empty-state"><div style="font-size:42px;opacity:.6">üìù</div><p>No to‚Äëdos in this view</p></div>`;
  } else {
    wrap.innerHTML = src.map(t=>{
      const clientBadges = t.clientIds.map(id=>{ const c=clients.find(x=>x.id===id); return c? `<span class="todo-client">${escapeHTML(fullNameOf(c))}</span>` : ''; }).join(' ');
      const due=new Date(t.date).toLocaleDateString();
      return `<div class="todo-item">
        <div>
          <div class="todo-title">${escapeHTML(t.title)}</div>
          <div class="todo-meta">${due} ‚Ä¢ ${t.status==='done'?'Done ‚úÖ':'Open'}</div>
          <div class="todo-clients">${clientBadges}</div>
          ${t.notes? `<div class="muted" style="margin-top:6px">${escapeHTML(t.notes)}</div>`:''}
        </div>
        <div style="margin-top:10px;display:flex;gap:6px;justify-content:flex-end;flex-wrap:wrap">
          <button class="btn ${t.status==='done'?'ghost':'primary'}" onclick="toggleTodo('${t.id}')">${t.status==='done'?'Reopen':'Mark Done'}</button>
          <button class="btn danger" onclick="deleteTodo('${t.id}')">Delete</button>
        </div>
      </div>`;
    }).join('');
  }

  const openCount=todos.filter(t=>t.status==='open').length; const doneCount=todos.filter(t=>t.status==='done').length;
  $('#todoCount').textContent=`${src.length} items ‚Ä¢ ${openCount} open / ${doneCount} done`;
}

/* =========================
   Dashboard
========================= */
function updateDashboard(){
  $('#totalClients').textContent = clients.length;
  $('#totalInteractions').textContent = interactions.length;
  const monthStart = new Date(); monthStart.setDate(1); monthStart.setHours(0,0,0,0);
  const activeThisMonth = new Set(interactions.filter(i=>new Date(i.date)>=monthStart).map(i=>i.clientId)).size;
  $('#activeThisMonth').textContent = activeThisMonth;
  const totalSales = clients.reduce((sum,c)=>sum+(Number(c.initialSales)||0),0) + sales.reduce((s,x)=>s+(Number(x.amount)||0),0);
  $('#totalSales').textContent = fmtUSD.format(totalSales);
}

/* =========================
   Import/Export JSON
========================= */
function exportData(){
  const payload={ exportedAt:new Date().toISOString(), version:5, clients, interactions, sales, followUps, todos };
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='crm-backup.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function importData(file){
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const data=JSON.parse(reader.result);
      if(!data||!Array.isArray(data.clients)||!Array.isArray(data.interactions)||!Array.isArray(data.sales)){ alert('Invalid file format.'); return; }
      clients = data.clients;
      interactions = data.interactions.map(i=>({ ...i, date:(i.date||'').slice(0,10) }));
      sales = data.sales.map(s=>({ ...s, amount:Number(s.amount)||0 }));
      followUps = Array.isArray(data.followUps)? data.followUps : [];
      todos = Array.isArray(data.todos)? data.todos : [];
      saveData(); loadData(); renderAll(); alert('Import complete ‚úîÔ∏è');
    }catch(e){ console.error(e); alert('Could not parse the file.'); }
  };
  reader.readAsText(file);
}

/* =========================
   CSV Import (Clients)
========================= */
function csvToRows(text){
  const rows = []; let row = [], cell = '';
  let i=0, inQuotes=false;
  while (i < text.length){
    const ch = text[i];
    if (inQuotes){
      if (ch === '"'){
        if (text[i+1] === '"'){ cell += '"'; i+=2; continue; }
        inQuotes = false; i++; continue;
      }
      cell += ch; i++; continue;
    } else {
      if (ch === '"'){ inQuotes = true; i++; continue; }
      if (ch === ','){ row.push(cell); cell=''; i++; continue; }
      if (ch === '\r'){ if (text[i+1] === '\n') i++; rows.push(row.concat(cell)); row=[]; cell=''; i++; continue; }
      if (ch === '\n'){ rows.push(row.concat(cell)); row=[]; cell=''; i++; continue; }
      cell += ch; i++; continue;
    }
  }
  if (cell.length || row.length) rows.push(row.concat(cell));
  if (rows.length && rows[0].length){ rows[0][0] = rows[0][0].replace(/^\uFEFF/, ''); }
  return rows;
}
function normalizeHeader(h){
  return String(h||'').trim().toLowerCase().replace(/[^a-z0-9]+/g,' ')
    .replace(/\s+(.)/g, (_,c)=>c.toUpperCase()).replace(/\s+/g,'')
    .replace(/^firstname$/,'firstName').replace(/^lastname$/,'lastName')
    .replace(/^emailaddress$/,'email').replace(/^phonenumber$|^phone$/,'phone')
    .replace(/^styles?$|^stylevibe$/,'styles')
    .replace(/^initialsales$|^initialamount$|^initialsale$/,'initialSales');
}
function csvToObjects(text){
  const rows = csvToRows(text).filter(r => r.length && r.some(c=>String(c).trim()!=='')); 
  if (!rows.length) return [];
  const headers = rows[0].map(normalizeHeader);
  return rows.slice(1).map(r=>{
    const o = {}; headers.forEach((h,idx)=>{ o[h] = (r[idx] ?? '').trim(); }); return o;
  });
}
function clientFromCsv(row){
  let firstName = row.firstName || ''; let lastName  = row.lastName  || '';
  if ((!firstName || !lastName) && row.name){
    const parts = String(row.name).trim().split(/\s+/); firstName = firstName || parts.shift() || ''; lastName  = lastName  || parts.join(' ');
  }
  const styles = normalizeStyles(row.styles || '');
  return {
    id: Date.now().toString() + Math.random().toString(36).slice(2,6),
    firstName: String(firstName).trim(),
    lastName:  String(lastName).trim(),
    email: String(row.email||'').trim(),
    phone: String(row.phone||'').trim(),
    styles,
    initialSales: Number(row.initialSales||0) || 0,
    notes: String(row.notes||'').trim(),
    createdAt: new Date().toISOString()
  };
}
function clientIdentityKey(c){
  if (c.email) return `email:${c.email.toLowerCase()}`;
  if (c.phone) return `phone:${c.phone.replace(/\D+/g,'')}`;
  const name = `${c.firstName||''} ${c.lastName||''}`.trim().toLowerCase();
  return name ? `name:${name}` : `id:${c.id}`;
}
function mergeClient(existing, incoming){
  return { ...existing, ...incoming, id: existing.id, createdAt: existing.createdAt || incoming.createdAt };
}
function importClientsFromCsvFile(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const rows = csvToObjects(reader.result);
      if (!rows.length){ alert('No rows found in CSV.'); return; }
      let added=0, updated=0, skipped=0;
      const index = new Map(); clients.forEach(c => index.set(clientIdentityKey(c), c.id));
      rows.forEach(r=>{
        const draft = clientFromCsv(r);
        const hasAny = draft.firstName || draft.lastName || draft.email || draft.phone;
        if (!hasAny){ skipped++; return; }
        const key = clientIdentityKey(draft);
        if (index.has(key)){
          const id = index.get(key);
          const i = clients.findIndex(c=>c.id===id);
          if (i !== -1){ clients[i] = mergeClient(clients[i], {...draft, id}); updated++; }
          else { draft.id = id; clients.push(draft); updated++; }
        } else { clients.push(draft); index.set(key, draft.id); added++; }
      });
      saveData(); renderClients(); updateDashboard(); populateTodoClientFilter();
      alert(`CSV import complete ‚úîÔ∏è\nAdded: ${added}\nUpdated: ${updated}\nSkipped: ${skipped}`);
    }catch(err){ console.error(err); alert('Could not parse CSV file.'); }
  };
  reader.readAsText(file);
}
</script>
</body>
</html>
