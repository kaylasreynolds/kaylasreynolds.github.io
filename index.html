<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Client Management</title>
<style>
  :root{
    --grad1:#4c51bf; --grad2:#553c9a;
    --ok:#2f855a;--ok2:#276749;
    --danger:#c53030;--danger2:#97266d;
    --text:#222;--muted:#555;--muted2:#888;
    --card:rgba(255,255,255,.95);--ring:#d6d6d6;
    --shadow:0 10px 30px rgba(0,0,0,.12);
  }
  *{box-sizing:border-box}html,body{height:100%}
  body{margin:0;font-family:system-ui, -apple-system, "Segoe UI", Inter, Roboto, Ubuntu, sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);color:var(--text)}
  .container{max-width:1200px;margin:auto;padding:20px}
  header{background:var(--card);backdrop-filter:blur(10px);border-radius:20px;padding:24px;margin-bottom:20px;box-shadow:var(--shadow)}
  h1{margin:0 0 6px;background:linear-gradient(135deg,var(--grad1),var(--grad2));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:16px 0}
  .tab{padding:10px 18px;border:0;border-radius:999px;background:#ffffff;cursor:pointer;font-weight:700;box-shadow:0 4px 15px rgba(0,0,0,.1)}
  .tab.active,[aria-selected="true"]{color:#fff;background:linear-gradient(135deg,var(--grad1),var(--grad2))}
  .stats-grid{display:grid;grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));gap:20px;margin-bottom:30px;align-items:stretch}
  .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:20px}
  .stat-number{font-size:2rem;font-weight:800;background:linear-gradient(135deg,var(--grad1),var(--grad2));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
  .muted{color:var(--muted);font-size:.95rem}
  .search{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;margin-bottom:12px}
  .search .row{display:flex;gap:10px}
 .search input,.search select{width:100%;padding:12px 14px;border-radius:12px;border:2px solid var(--ring);font-size:1rem}
  .dropdown{position:relative}
  .dropdown-menu{display:none;position:absolute;top:100%;left:0;background:#fff;border:2px solid var(--ring);padding:10px;border-radius:12px;box-shadow:var(--shadow);z-index:20;min-width:180px}
  .dropdown-menu.show{display:block}
  .dropdown-menu label{display:block;font-weight:700;margin:4px 0 2px}
  .dropdown-menu select,.dropdown-menu input{width:100%;padding:6px 8px;border-radius:8px;border:2px solid var(--ring);font-size:.9rem;margin-bottom:6px}
  .list{display:grid;gap:12px}
  .client-header{display:flex;justify-content:space-between;gap:12px}
  .client-name{font-weight:800}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:.75rem;font-weight:700}
  .status-introductory{background:#e6f0ff;color:#1a365d}
  .status-first-appointment{background:#fffbea;color:#744210}
  .status-established{background:#c6f6d5;color:#22543d}
  .badge-sale{background:linear-gradient(135deg,var(--ok),var(--ok2));color:#fff;padding:4px 10px;border-radius:999px;font-size:.75rem;font-weight:800;margin-left:8px}
  .buttons{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .btn{padding:10px 16px;border:0;border-radius:999px;font-weight:800;cursor:pointer}
  .btn.primary{color:#fff;background:linear-gradient(135deg,var(--grad1),var(--grad2))}
  .btn.ghost{background:#e5e5e5}
  .btn.danger{color:#fff;background:linear-gradient(135deg,var(--danger),var(--danger2))}
  .btn.small{padding:6px 10px;font-size:.85rem}
  .tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
  .tag{background:#eef;color:#333;padding:4px 10px;border-radius:999px;font-size:.75rem;font-weight:700}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:10}
  .modal.active{display:flex}
  .panel{background:#fff;border-radius:16px;width:min(720px,92vw);max-height:90vh;overflow:auto;padding:20px}
  .panel header{display:flex;align-items:center;justify-content:space-between;margin:0 0 10px}
  .x{background:transparent;border:0;font-size:22px;cursor:pointer;color:var(--muted2)}
  label{display:block;font-weight:700;margin:12px 0 6px}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:2px solid var(--ring);font-size:1rem}
  textarea{min-height:90px;resize:vertical}
  .row-cols{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
  .empty-state{text-align:center;color:var(--muted2);padding:28px}
  .todo-list{display:grid;gap:10px}
  .todo-item{background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:12px;border-left:4px solid #4c51bf;display:flex;flex-direction:column}
  .todo-title{font-weight:800}
  .todo-meta{font-size:.85rem;color:var(--muted)}
  .todo-clients{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .todo-client{background:#eef;border-radius:999px;padding:2px 8px;font-size:.8rem}
  .followup-sections{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .followup-card{background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);border-left:4px solid transparent;padding:12px;display:flex;flex-direction:column;gap:10px}
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;font-size:.8rem;text-align:center}
  .calendar div{background:#fff;border-radius:8px;padding:4px;min-height:40px;position:relative}
  .calendar .day{font-weight:700;margin-bottom:4px}
  .calendar .bday{position:absolute;bottom:4px;left:4px;font-size:.7rem;display:flex;align-items:center;gap:4px}
  .season-table{width:100%;border-collapse:collapse}
  .season-table th,.season-table td{padding:8px;border:1px solid var(--ring);text-align:center}
  @media (max-width:900px){.container{padding:12px}}
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Client Management</h1>
      <div class="toolbar">
        <button id="exportBtn" class="btn ghost">‚¨áÔ∏è Export JSON</button>
        <button id="importBtn" class="btn ghost">‚¨ÜÔ∏è Import JSON</button>
        <input id="importFile" type="file" accept="application/json" style="display:none">
        <button id="clearBtn" class="btn danger">üóëÔ∏è Clear Data</button>
      </div>
    </header>

    <div class="tabs" role="tablist">
      <button class="tab active" data-tab="dashboard">üìä Dashboard</button>
      <button class="tab" data-tab="clients">üë• Clients</button>
      <button class="tab" data-tab="appointments">üìÜ Appointments</button>
      <button class="tab" data-tab="sales">üí∞ Sales History</button>
      <button class="tab" data-tab="outreach">üì£ Outreach</button>
      <button class="tab" data-tab="birthdays">üéÇ Birthdays</button>
      <button class="tab" data-tab="seasonal">üçÉ Seasonal Updates</button>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="tab-content">
      <div class="stats-grid">
        <div class="card"><div class="stat-number" id="salesMTD">$0</div><div class="muted">Sales MTD</div></div>
        <div class="card"><div class="stat-number" id="salesYTD">$0</div><div class="muted">Sales YTD</div></div>
        <div class="card"><div class="stat-number" id="apptMTD">0</div><div class="muted">Appointments MTD</div></div>
        <div class="card"><div class="stat-number" id="apptYTD">0</div><div class="muted">Appointments YTD</div></div>
        <div class="card"><div class="stat-number" id="pastDueOutreach">0</div><div class="muted">Past Due Outreach</div></div>
      </div>
      <h3>Upcoming</h3>
      <div id="upcomingList" class="list"></div>
      <h3>Follow-Up Tracking</h3>
      <div class="followup-sections">
        <div class="followup-card"><strong>Open To-Dos</strong><div id="fuOpen" class="todo-list"></div></div>
        <div class="followup-card"><strong>Past Due</strong><div id="fuPast" class="todo-list"></div></div>
        <div class="followup-card"><strong>911 Follow-Ups</strong><div id="fuUrgent" class="todo-list"></div></div>
        <div class="followup-card"><strong>This Week</strong><div id="fuWeek" class="todo-list"></div></div>
      </div>
    </div>

    <!-- Clients -->
    <div id="clients" class="tab-content" style="display:none">
      <div class="card">
        <div class="client-top" style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap;margin-bottom:12px">
          <div style="flex:1;min-width:220px">
            <h2 style="margin:0">Client List</h2>
            <div class="toolbar" style="margin-top:8px">
              <div class="dropdown" id="filterDropdown">
                <button class="btn ghost" id="filterToggle">Filter ‚ñæ</button>
                <div class="dropdown-menu" id="filterMenu">
                  <label>Styles</label>
                  <select id="filterStyles" multiple>
                    <option value="Classic">Classic</option>
                    <option value="Minimalist">Minimalist</option>
                    <option value="Casual">Casual</option>
                    <option value="Business">Business</option>
                  </select>
                  <label>Brands</label>
                  <input id="filterBrand" list="brandList">
                  <label>Sort By</label>
                  <select id="filterSort">
                    <option value="">None</option>
                    <option value="lastAsc">Last Name Ascending</option>
                    <option value="lastDesc">Last Name Descending</option>
                    <option value="firstAsc">First Name Ascending</option>
                    <option value="firstDesc">First Name Descending</option>
                  </select>
                  <button id="clearFilters" class="btn small ghost" style="margin-top:4px;width:100%">Clear Filters</button>
                </div>
              </div>
              <input type="text" id="clientSearch" placeholder="Search clients">
            </div>
          </div>
          <div style="text-align:right;min-width:180px">
            <div id="clientCount" class="muted" style="font-weight:700;margin-bottom:10px"></div>
            <button id="openClientBtn" class="btn primary">Create Client</button>
          </div>
        </div>
        <datalist id="brandList"></datalist>
        <div class="list" id="clientList"></div>
      </div>
    </div>

    <!-- Appointments -->
    <div id="appointments" class="tab-content" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px">
          <h2 style="margin:0">Appointments</h2>
          <button id="openApptBtn" class="btn primary">+ Schedule</button>
        </div>
        <div class="list" id="apptList"></div>
      </div>
    </div>

    <!-- Sales -->
    <div id="sales" class="tab-content" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px">
          <h2 style="margin:0">Sales History</h2>
          <button id="openSaleBtn" class="btn primary">+ Log Sale</button>
        </div>
        <div class="toolbar" style="margin-bottom:12px">
          <input type="text" id="saleSearch" placeholder="Search sales">
          <select id="saleClientFilter"></select>
        </div>
        <div class="list" id="saleList"></div>
      </div>
    </div>

    <!-- Outreach -->
    <div id="outreach" class="tab-content" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px">
          <h2 style="margin:0">Outreach</h2>
          <button id="openTodoBtn" class="btn primary">+ Add Outreach</button>
        </div>
        <div class="list" id="todoList"></div>
      </div>
    </div>

    <!-- Birthdays -->
    <div id="birthdays" class="tab-content" style="display:none">
      <div class="card">
        <h2 style="margin-top:0">Birthdays</h2>
        <div id="birthdayCalendar" class="calendar"></div>
        <h3>All Birthdays</h3>
        <div id="birthdayList" class="list"></div>
      </div>
    </div>

    <!-- Seasonal Updates -->
    <div id="seasonal" class="tab-content" style="display:none">
      <div class="card">
        <h2 style="margin-top:0">Seasonal Updates</h2>
        <table class="season-table" id="seasonTable">
          <thead><tr><th>Client</th><th>Spring</th><th>Summer</th><th>Fall</th><th>Winter</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div> <!-- container -->

  <!-- Client Modal -->
  <div class="modal" id="clientModal">
    <div class="panel">
      <header><h3 id="clientModalTitle">New Client</h3><button class="x" onclick="closeModal('clientModal')">‚úï</button></header>
      <div class="row-cols">
        <div><label>First Name<input id="clientFirst"></label></div>
        <div><label>Last Name<input id="clientLast"></label></div>
      </div>
      <label>Email<input id="clientEmail" type="email"></label>
      <label>Phone<input id="clientPhone"></label>
      <label>Birthday<input id="clientBirthday" type="date"></label>
      <label>Preferred Styles<select id="clientStyles" multiple>
        <option value="Classic">Classic</option>
        <option value="Minimalist">Minimalist</option>
        <option value="Casual">Casual</option>
        <option value="Business">Business</option>
      </select></label>
      <label>Preferred Brands<input id="clientBrands" list="brandList" placeholder="Comma separated"></label>
      <div class="row-cols">
        <div><label>Shirt Size<input id="clientSizeShirt"></label></div>
        <div><label>Dress Size<input id="clientSizeDress"></label></div>
        <div><label>Pant Size<input id="clientSizePant"></label></div>
        <div><label>Shoe Size<input id="clientSizeShoe"></label></div>
      </div>
      <label>Initial Sales Amount<input id="clientInitial" type="number" step="0.01"></label>
      <label>Notes<textarea id="clientNotes"></textarea></label>
      <div class="buttons" style="justify-content:flex-end">
        <button class="btn ghost" onclick="closeModal('clientModal')">Cancel</button>
        <button class="btn primary" id="saveClientBtn">Save</button>
      </div>
    </div>
  </div>

  <!-- Client Detail Modal -->
  <div class="modal" id="clientDetailModal">
    <div class="panel">
      <header><h3 id="clientDetailName"></h3><button class="x" onclick="closeModal('clientDetailModal')">‚úï</button></header>
      <div id="clientInfo" class="list"></div>
      <div id="clientTimeline" class="list"></div>
      <div class="buttons" style="justify-content:flex-end">
        <button class="btn" onclick="openAppointmentModal(null,[currentDetailClient])">Book Appointment</button>
        <button class="btn" onclick="openSaleModal(null,currentDetailClient)">Log Sale</button>
        <button class="btn" onclick="openTodoModal(null,[currentDetailClient])">Add Outreach</button>
      </div>
    </div>
  </div>

  <!-- Appointment Modal -->
  <div class="modal" id="apptModal">
    <div class="panel">
      <header><h3 id="apptModalTitle">Schedule Appointment</h3><button class="x" onclick="closeModal('apptModal')">‚úï</button></header>
      <label>Title<input id="apptTitle"></label>
      <label>Date/Time<input id="apptDate" type="datetime-local"></label>
      <label>Status<select id="apptStatus"><option value="scheduled">Scheduled</option><option value="completed">Completed</option><option value="canceled">Canceled</option><option value="no-show">No-Show</option></select></label>
      <label>Notes<textarea id="apptNotes"></textarea></label>
      <label>Clients<select id="apptClients" multiple></select></label>
      <div class="buttons" style="justify-content:flex-end">
        <button class="btn ghost" onclick="closeModal('apptModal')">Cancel</button>
        <button class="btn primary" id="saveApptBtn">Save</button>
      </div>
    </div>
  </div>

  <!-- Sale Modal -->
  <div class="modal" id="saleModal">
    <div class="panel">
      <header><h3 id="saleModalTitle">Log Sale</h3><button class="x" onclick="closeModal('saleModal')">‚úï</button></header>
      <label>Client<select id="saleClient"></select></label>
      <label>Amount<input id="saleAmount" type="number" step="0.01"></label>
      <label>Date<input id="saleDate" type="date"></label>
      <label>Description<textarea id="saleDesc"></textarea></label>
      <label>Appointment<select id="saleAppt"><option value="">None</option></select></label>
      <div class="buttons" style="justify-content:flex-end">
        <button class="btn ghost" onclick="closeModal('saleModal')">Cancel</button>
        <button class="btn primary" id="saveSaleBtn">Save</button>
      </div>
    </div>
  </div>

  <!-- Outreach Modal -->
  <div class="modal" id="todoModal">
    <div class="panel">
      <header><h3 id="todoModalTitle">Add Outreach</h3><button class="x" onclick="closeModal('todoModal')">‚úï</button></header>
      <label>Title<input id="todoTitle"></label>
      <label>Date<input id="todoDate" type="date"></label>
      <label>Category<select id="todoCategory">
        <option>Follow-up</option>
        <option>Pre-appointment</option>
        <option>Cold/Warm Outreach</option>
        <option>Promo</option>
        <option>Event</option>
      </select></label>
      <label>Notes<textarea id="todoNotes"></textarea></label>
      <label>Clients<select id="todoClients" multiple></select></label>
      <label>Appointment<select id="todoAppt"><option value="">None</option></select></label>
      <div class="buttons" style="justify-content:flex-end">
        <button class="btn ghost" onclick="closeModal('todoModal')">Cancel</button>
        <button class="btn primary" id="saveTodoBtn">Save</button>
      </div>
    </div>
  </div>

<script>
/* ===== Data ===== */
let clients=[], appointments=[], sales=[], outreach=[];
let currentEditClient=null,currentEditAppt=null,currentEditSale=null,currentEditTodo=null,currentDetailClient=null;
const fmtUSD=new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'});
function saveData(){localStorage.setItem('crmData',JSON.stringify({clients,appointments,sales,outreach}));}
function loadData(){
  const d=JSON.parse(localStorage.getItem('crmData')||'{}');
  clients=(d.clients||[]).map(c=>({
    ...c,
    styles:c.styles||(c.style?[c.style]:[]),
    brands:c.brands||(c.brand?[c.brand]:[]),
    sizeShirt:c.sizeShirt||'',
    sizeDress:c.sizeDress||'',
    sizePant:c.sizePant||'',
    sizeShoe:c.sizeShoe||'',
    initialSale:c.initialSale||0
  }));
  appointments=d.appointments||[];
  sales=d.sales||[];
  outreach=d.outreach||[];
}
  loadData();

/* ===== Utils ===== */
const $=sel=>document.querySelector(sel);
function closeModal(id){$('#'+id).classList.remove('active');}
function openModal(id){$('#'+id).classList.add('active');}
function fullName(c){return `${c.first||''} ${c.last||''}`.trim();}
function uuid(){return Math.random().toString(36).slice(2,9);}
function todayStr(){return new Date().toISOString().split('T')[0];}

/* ===== Tabs ===== */
document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
  $('#'+btn.dataset.tab).style.display='block';
  renderAll();
}));

/* ===== Clients ===== */
function renderClients(){
  const list=$('#clientList');
  const q=$('#clientSearch').value.toLowerCase();
  const styles=[...$('#filterStyles').selectedOptions].map(o=>o.value);
  const brand=$('#filterBrand').value.toLowerCase().trim();
  let src=clients.filter(c=>fullName(c).toLowerCase().includes(q));
  if(styles.length) src=src.filter(c=>(c.styles||[]).some(s=>styles.includes(s)));
  if(brand) src=src.filter(c=>(c.brands||[]).some(b=>b.toLowerCase().includes(brand)));
  const sort=$('#filterSort').value;
  if(sort==='lastAsc') src.sort((a,b)=>a.last.localeCompare(b.last));
  if(sort==='lastDesc') src.sort((a,b)=>b.last.localeCompare(a.last));
  if(sort==='firstAsc') src.sort((a,b)=>a.first.localeCompare(b.first));
  if(sort==='firstDesc') src.sort((a,b)=>b.first.localeCompare(a.first));
  $('#clientCount').textContent=`Total Clients: ${clients.length}`;
  const brands=[...new Set(clients.flatMap(c=>c.brands||[]).filter(Boolean))];
  $('#brandList').innerHTML=brands.map(b=>`<option value="${b}"></option>`).join('');
   if(!src.length){
    list.innerHTML='<div class="empty-state"><div style="font-size:42px;opacity:.6">üë•</div><p>No clients</p></div>';
    return;
  }
  list.innerHTML=src.map(c=>{
    const total=sales.filter(s=>s.clientId===c.id).reduce((a,b)=>a+b.amount,0)+(c.initialSale||0);
    const appts=appointments.filter(a=>a.clientIds.includes(c.id));
    const apptList=appts.map(a=>`<li><a href="#" onclick="editAppt('${a.id}')">${a.title} - ${new Date(a.date).toLocaleDateString()}</a></li>`).join('');
    return `<div class="card"><div class="client-header"><div class="client-name">${fullName(c)}</div><div class="buttons"><button class="btn small" onclick="viewClient('${c.id}')">View</button><button class="btn small" onclick="editClient('${c.id}')">Edit</button><button class="btn small danger" onclick="deleteClient('${c.id}')">Delete</button></div></div>
    <div>Running Sales: ${fmtUSD.format(total)}</div>
    <div>Appointments:<ul>${apptList}</ul></div></div>`;
  }).join('');
}
$('#clientSearch').addEventListener('input',renderClients);
$('#filterStyles').addEventListener('change',renderClients);
$('#filterBrand').addEventListener('input',renderClients);
$('#filterSort').addEventListener('change',renderClients);
$('#clearFilters').addEventListener('click',()=>{
  [...$('#filterStyles').options].forEach(o=>o.selected=false);
  $('#filterBrand').value='';
  $('#filterSort').value='';
  $('#clientSearch').value='';
  renderClients();
  $('#filterMenu').classList.remove('show');
});
$('#filterToggle').onclick=()=>$('#filterMenu').classList.toggle('show');
document.addEventListener('click',e=>{if(!$('#filterDropdown').contains(e.target))$('#filterMenu').classList.remove('show');});
$('#openClientBtn').onclick=()=>{
  currentEditClient=null;
  $('#clientModalTitle').textContent='New Client';
  $('#clientFirst').value='';
  $('#clientLast').value='';
  $('#clientEmail').value='';
  $('#clientPhone').value='';
  $('#clientBirthday').value='';
  [...$('#clientStyles').options].forEach(o=>o.selected=false);
  $('#clientBrands').value='';
  $('#clientSizeShirt').value='';
  $('#clientSizeDress').value='';
  $('#clientSizePant').value='';
  $('#clientSizeShoe').value='';
  $('#clientInitial').value='';
  $('#clientNotes').value='';
  openModal('clientModal');
};
  $('#saveClientBtn').onclick=()=>{
  const obj={
    id:currentEditClient?.id||uuid(),
    first:$('#clientFirst').value.trim(),
    last:$('#clientLast').value.trim(),
    email:$('#clientEmail').value.trim(),
    phone:$('#clientPhone').value.trim(),
    birthday:$('#clientBirthday').value,
    styles:[...$('#clientStyles').selectedOptions].map(o=>o.value),
    brands:$('#clientBrands').value.split(',').map(s=>s.trim()).filter(Boolean),
    sizeShirt:$('#clientSizeShirt').value.trim(),
    sizeDress:$('#clientSizeDress').value.trim(),
    sizePant:$('#clientSizePant').value.trim(),
    sizeShoe:$('#clientSizeShoe').value.trim(),
    initialSale:Number($('#clientInitial').value||0),
    notes:$('#clientNotes').value
  };
  if(currentEditClient){Object.assign(currentEditClient,obj);}else{clients.push(obj);createSeasonalOutreach(obj);}saveData();closeModal('clientModal');renderAll();};
function editClient(id){
  currentEditClient=clients.find(c=>c.id===id);
  if(!currentEditClient)return;
  $('#clientModalTitle').textContent='Edit Client';
  $('#clientFirst').value=currentEditClient.first||'';
  $('#clientLast').value=currentEditClient.last||'';
  $('#clientEmail').value=currentEditClient.email||'';
  $('#clientPhone').value=currentEditClient.phone||'';
  $('#clientBirthday').value=currentEditClient.birthday||'';
  [...$('#clientStyles').options].forEach(o=>o.selected=(currentEditClient.styles||[]).includes(o.value));
  $('#clientBrands').value=(currentEditClient.brands||[]).join(', ');
  $('#clientSizeShirt').value=currentEditClient.sizeShirt||'';
  $('#clientSizeDress').value=currentEditClient.sizeDress||'';
  $('#clientSizePant').value=currentEditClient.sizePant||'';
  $('#clientSizeShoe').value=currentEditClient.sizeShoe||'';
  $('#clientInitial').value=currentEditClient.initialSale||'';
  $('#clientNotes').value=currentEditClient.notes||'';
  openModal('clientModal');
}
function deleteClient(id){if(!confirm('Delete client?'))return;clients=clients.filter(c=>c.id!==id);outreach=outreach.filter(o=>!o.clientIds.includes(id));appointments.forEach(a=>a.clientIds=a.clientIds.filter(cid=>cid!==id));sales=sales.filter(s=>s.clientId!==id);saveData();renderAll();}
function viewClient(id){
  currentDetailClient=id;
  const c=clients.find(x=>x.id===id);
  if(!c)return;
  $('#clientDetailName').textContent=fullName(c);
  const total=sales.filter(s=>s.clientId===id).reduce((a,b)=>a+b.amount,0)+(c.initialSale||0);
  $('#clientInfo').innerHTML=
    `<div>Email: ${c.email||''}</div>`+
    `<div>Phone: ${c.phone||''}</div>`+
    `<div>Birthday: ${c.birthday?new Date(c.birthday).toLocaleDateString():''}</div>`+
    `<div>Preferred Styles: ${(c.styles||[]).join(', ')}</div>`+
    `<div>Preferred Brands: ${(c.brands||[]).join(', ')}</div>`+
    `<div>Sizes: Shirt ${c.sizeShirt||''} | Dress ${c.sizeDress||''} | Pant ${c.sizePant||''} | Shoe ${c.sizeShoe||''}</div>`+
    `<div>Initial Sales Amount: ${fmtUSD.format(c.initialSale||0)}</div>`+
    `<div>Running Sales: ${fmtUSD.format(total)}</div>`+
    `<div>Notes: ${c.notes||''}</div>`;
  const timeline=[];
  appointments.filter(a=>a.clientIds.includes(id)).forEach(a=>timeline.push({type:'Appointment',date:a.date,desc:a.title}));
  sales.filter(s=>s.clientId===id).forEach(s=>timeline.push({type:'Sale',date:s.date,desc:fmtUSD.format(s.amount)}));
  outreach.filter(o=>o.clientIds.includes(id)).forEach(o=>timeline.push({type:'Outreach',date:o.date,desc:o.title}));
  timeline.sort((a,b)=>a.date.localeCompare(b.date));
  $('#clientTimeline').innerHTML=timeline.map(t=>`<div class="todo-item"><div class="todo-title">${t.type}: ${t.desc}</div><div class="todo-meta">${new Date(t.date).toLocaleString()}</div></div>`).join('');
  openModal('clientDetailModal');
}
function createSeasonalOutreach(client){const yr=new Date().getFullYear();const seasons=[['Spring','03-01'],['Summer','06-01'],['Fall','09-01'],['Winter','12-01']];seasons.forEach(([season,md])=>{outreach.push({id:uuid(),title:`${season} Update`,category:'Seasonal',date:`${yr}-${md}`,status:'open',clientIds:[client.id]});});}

/* ===== Appointments ===== */
function renderAppointments(){const list=$('#apptList');if(!appointments.length){list.innerHTML='<div class="empty-state"><div style="font-size:42px;opacity:.6">üìÜ</div><p>No appointments</p></div>';return;}appointments.sort((a,b)=>a.date.localeCompare(b.date));list.innerHTML=appointments.map(a=>`<div class="card"><div class="client-header"><div><div class="client-name">${a.title}</div><div class="muted">${new Date(a.date).toLocaleString()} ‚Ä¢ ${a.status}</div></div><div class="buttons"><button class="btn small" onclick="editAppt('${a.id}')">Edit</button><button class="btn small danger" onclick="deleteAppt('${a.id}')">Delete</button></div></div></div>`).join('');}
$('#openApptBtn').onclick=()=>openAppointmentModal();
function openAppointmentModal(id,preClients=[]){currentEditAppt=id?appointments.find(a=>a.id===id):null;$('#apptModalTitle').textContent=id?'Edit Appointment':'Schedule Appointment';$('#apptTitle').value=currentEditAppt?.title||'';$('#apptDate').value=currentEditAppt?.date?currentEditAppt.date.slice(0,16):'';$('#apptStatus').value=currentEditAppt?.status||'scheduled';$('#apptNotes').value=currentEditAppt?.notes||'';populateClientSelect('#apptClients',currentEditAppt?.clientIds||preClients);openModal('apptModal');}
function populateClientSelect(sel,vals=[]){const s=$(sel);s.innerHTML=clients.map(c=>`<option value="${c.id}">${fullName(c)}</option>`).join('');[...s.options].forEach(o=>{if(vals.includes(o.value))o.selected=true;});}
function populateClientFilter(sel){const s=$(sel);s.innerHTML='<option value="">All Clients</option>'+clients.map(c=>`<option value="${c.id}">${fullName(c)}</option>`).join('');}
$('#saveApptBtn').onclick=()=>{const obj={id:currentEditAppt?.id||uuid(),title:$('#apptTitle').value,date:$('#apptDate').value,status:$('#apptStatus').value,notes:$('#apptNotes').value,clientIds:[...$('#apptClients').selectedOptions].map(o=>o.value)};const wasCompleted=currentEditAppt?.status==='completed';if(currentEditAppt){Object.assign(currentEditAppt,obj);}else{appointments.push(obj);}saveData();closeModal('apptModal');if(obj.status==='completed'&&!wasCompleted){obj.clientIds.forEach(cid=>{outreach.push({id:uuid(),title:'Post-Appointment Follow-up',category:'Follow-up',date:todayStr(),status:'open',clientIds:[cid],appointmentId:obj.id});});saveData();}renderAll();};
function editAppt(id){openAppointmentModal(id);}
function deleteAppt(id){if(!confirm('Delete appointment?'))return;appointments=appointments.filter(a=>a.id!==id);outreach=outreach.filter(o=>o.appointmentId!==id);sales.forEach(s=>{if(s.appointmentId===id)s.appointmentId='';});saveData();renderAll();}

/* ===== Sales ===== */
function renderSales(){const list=$('#saleList');if(!sales.length){list.innerHTML='<div class="empty-state"><div style="font-size:42px;opacity:.6">üí∞</div><p>No sales</p></div>';return;}let filtered=[...sales];const search=$('#saleSearch')?.value.toLowerCase()||'';const cid=$('#saleClientFilter')?.value||'';if(search){filtered=filtered.filter(s=>{const c=clients.find(x=>x.id===s.clientId);const name=c?fullName(c).toLowerCase():'';const desc=(s.desc||'').toLowerCase();return name.includes(search)||desc.includes(search)||String(s.amount).includes(search);});}if(cid){filtered=filtered.filter(s=>s.clientId===cid);}if(!filtered.length){list.innerHTML='<div class="empty-state"><div style="font-size:42px;opacity:.6">üí∞</div><p>No matching sales</p></div>';return;}filtered.sort((a,b)=>a.date.localeCompare(b.date));list.innerHTML=filtered.map(s=>{const c=clients.find(x=>x.id===s.clientId);return `<div class="card"><div class="client-header"><div><div class="client-name">${fmtUSD.format(s.amount)}</div><div class="muted">${new Date(s.date).toLocaleDateString()} ‚Ä¢ ${c?fullName(c):''}</div></div><div class="buttons"><button class="btn small" onclick="editSale('${s.id}')">Edit</button><button class="btn small danger" onclick="deleteSale('${s.id}')">Delete</button></div></div></div>`;}).join('');}
$('#openSaleBtn').onclick=()=>openSaleModal();
$('#saleSearch').addEventListener('input',renderSales);
$('#saleClientFilter').addEventListener('change',renderSales);
function openSaleModal(id,preClient){currentEditSale=id?sales.find(s=>s.id===id):null;$('#saleModalTitle').textContent=id?'Edit Sale':'Log Sale';populateClientSelect('#saleClient',[currentEditSale?.clientId||preClient].filter(Boolean));$('#saleAmount').value=currentEditSale?.amount||'';$('#saleDate').value=currentEditSale?.date||todayStr();$('#saleDesc').value=currentEditSale?.desc||'';populateApptSelect('#saleAppt',currentEditSale?.appointmentId||'');openModal('saleModal');}
function populateApptSelect(sel,val){const s=$(sel);s.innerHTML='<option value="">None</option>'+appointments.map(a=>`<option value="${a.id}">${a.title}</option>`).join('');s.value=val||'';}
$('#saveSaleBtn').onclick=()=>{const obj={id:currentEditSale?.id||uuid(),clientId:$('#saleClient').value,amount:Number($('#saleAmount').value||0),date:$('#saleDate').value,desc:$('#saleDesc').value,appointmentId:$('#saleAppt').value};if(currentEditSale){Object.assign(currentEditSale,obj);}else{sales.push(obj);}saveData();closeModal('saleModal');renderAll();};
function editSale(id){openSaleModal(id);}
function deleteSale(id){if(!confirm('Delete sale?'))return;sales=sales.filter(s=>s.id!==id);saveData();renderAll();}

/* ===== Outreach ===== */
function renderTodos(){const list=$('#todoList');if(!outreach.length){list.innerHTML='<div class="empty-state"><div style="font-size:42px;opacity:.6">üì£</div><p>No outreach</p></div>';return;}outreach.sort((a,b)=>a.date.localeCompare(b.date));list.innerHTML=outreach.map(t=>{const cs=t.clientIds.map(id=>{const c=clients.find(x=>x.id===id);return c?`<span class="todo-client">${fullName(c)}</span>`:''}).join('');return `<div class="todo-item"><div><div class="todo-title">${t.title}</div><div class="todo-meta">${new Date(t.date).toLocaleDateString()} ‚Ä¢ ${t.category} ‚Ä¢ ${t.status}</div><div class="todo-clients">${cs}</div></div><div style="margin-top:8px;display:flex;gap:6px;justify-content:flex-end"><button class="btn small" onclick="toggleTodo('${t.id}')">${t.status==='open'?'Done':'Reopen'}</button><button class="btn small" onclick="editTodo('${t.id}')">Edit</button><button class="btn small danger" onclick="deleteTodo('${t.id}')">Delete</button></div></div>`;}).join('');}
$('#openTodoBtn').onclick=()=>openTodoModal();
function openTodoModal(id,preClients=[]){currentEditTodo=id?outreach.find(t=>t.id===id):null;$('#todoModalTitle').textContent=id?'Edit Outreach':'Add Outreach';$('#todoTitle').value=currentEditTodo?.title||'';$('#todoDate').value=currentEditTodo?.date||todayStr();$('#todoCategory').value=currentEditTodo?.category||'Follow-up';$('#todoNotes').value=currentEditTodo?.notes||'';populateClientSelect('#todoClients',currentEditTodo?.clientIds||preClients);populateApptSelect('#todoAppt',currentEditTodo?.appointmentId||'');openModal('todoModal');}
$('#saveTodoBtn').onclick=()=>{const obj={id:currentEditTodo?.id||uuid(),title:$('#todoTitle').value,date:$('#todoDate').value,category:$('#todoCategory').value,notes:$('#todoNotes').value,status:currentEditTodo?.status||'open',clientIds:[...$('#todoClients').selectedOptions].map(o=>o.value),appointmentId:$('#todoAppt').value};if(currentEditTodo){Object.assign(currentEditTodo,obj);}else{outreach.push(obj);}saveData();closeModal('todoModal');renderAll();};
function editTodo(id){openTodoModal(id);}
function toggleTodo(id){const t=outreach.find(x=>x.id===id);if(!t)return;t.status=t.status==='open'?'done':'open';saveData();renderAll();}
function deleteTodo(id){if(!confirm('Delete outreach?'))return;outreach=outreach.filter(t=>t.id!==id);saveData();renderAll();}

/* ===== Birthdays ===== */
function renderBirthdays(){const cal=$('#birthdayCalendar');const list=$('#birthdayList');if(!clients.length){cal.innerHTML='<div class="empty-state" style="grid-column:span 7">No data</div>';list.innerHTML='';return;}const now=new Date();const month=now.getMonth();const first=new Date(now.getFullYear(),month,1);const startDay=first.getDay();const days=new Date(now.getFullYear(),month+1,0).getDate();cal.innerHTML='';const weekdays=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];weekdays.forEach(d=>cal.innerHTML+=`<div class="day">${d}</div>`);for(let i=0;i<startDay;i++)cal.innerHTML+='<div></div>';for(let d=1;d<=days;d++){const date=`${now.getFullYear()}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;const bd=clients.filter(c=>c.birthday===date);const cell=document.createElement('div');cell.innerHTML=`<div class="day">${d}</div>`;bd.forEach(c=>{cell.innerHTML+=`<div class="bday"><input type="checkbox" data-bday="${c.id}"> ${fullName(c)}</div>`;});cal.appendChild(cell);}const months=[...Array(12).keys()].map(m=>({m,arr:clients.filter(c=>new Date(c.birthday).getMonth()===m)})).filter(o=>o.arr.length);list.innerHTML=months.map(o=>`<div class="card"><strong>${new Date(2020,o.m).toLocaleString('default',{month:'long'})}</strong><ul>${o.arr.map(c=>`<li><input type="checkbox" data-bday="${c.id}"> ${fullName(c)} - ${new Date(c.birthday).getDate()}</li>`).join('')}</ul></div>`).join('');}

/* ===== Seasonal Updates ===== */
function renderSeasonal(){const body=$('#seasonTable tbody');if(!clients.length){body.innerHTML='';return;}body.innerHTML=clients.map(c=>{const seasons=['Spring','Summer','Fall','Winter'];const cells=seasons.map(se=>{const t=outreach.find(o=>o.category==='Seasonal'&&o.title.includes(se)&&o.clientIds.includes(c.id));const checked=t&&t.status==='done';return `<td><input type="checkbox" onchange="seasonToggle('${t.id}',$event.target.checked)" ${checked?'checked':''}></td>`;}).join('');return `<tr><td>${fullName(c)}</td>${cells}</tr>`;}).join('');}
function seasonToggle(id,val){const t=outreach.find(o=>o.id===id);if(t){t.status=val?'done':'open';saveData();renderAll();}}

/* ===== Dashboard ===== */
function renderDashboard(){const now=new Date();const mStart=new Date(now.getFullYear(),now.getMonth(),1);const yStart=new Date(now.getFullYear(),0,1);const salesMTD=sales.filter(s=>new Date(s.date)>=mStart).reduce((a,b)=>a+b.amount,0);const salesYTD=sales.filter(s=>new Date(s.date)>=yStart).reduce((a,b)=>a+b.amount,0);$('#salesMTD').textContent=fmtUSD.format(salesMTD);$('#salesYTD').textContent=fmtUSD.format(salesYTD);const apptMTD=appointments.filter(a=>new Date(a.date)>=mStart && new Date(a.date)<=now).length;const apptYTD=appointments.filter(a=>new Date(a.date)>=yStart && new Date(a.date)<=now).length;$('#apptMTD').textContent=apptMTD;$('#apptYTD').textContent=apptYTD;const past=outreach.filter(t=>t.status==='open'&&new Date(t.date)<now).length;$('#pastDueOutreach').textContent=past;const events=[...appointments.map(a=>({type:'Appt',title:a.title,date:a.date})),...outreach.filter(o=>o.status==='open').map(o=>({type:'Outreach',title:o.title,date:o.date}))];events.filter(e=>new Date(e.date)>=now).sort((a,b)=>a.date.localeCompare(b.date));$('#upcomingList').innerHTML=events.filter(e=>new Date(e.date)>=now).sort((a,b)=>a.date.localeCompare(b.date)).slice(0,5).map(e=>`<div class="card"><div class="client-header"><div><div class="client-name">${e.title}</div><div class="muted">${e.type} ‚Ä¢ ${new Date(e.date).toLocaleString()}</div></div></div></div>`).join('');const open=outreach.filter(t=>t.status==='open');const pastDue=open.filter(t=>new Date(t.date)<now);const urgent=open.filter(t=>new Date(t.date)<new Date(now.getTime()-14*86400000));const weekEnd=new Date(now);weekEnd.setDate(now.getDate()+(7-now.getDay()));const thisWeek=open.filter(t=>{const d=new Date(t.date);return d>=now && d<=weekEnd;});function renderFU(src,el){if(!src.length){el.innerHTML='<div class="muted">None</div>';return;}el.innerHTML=src.sort((a,b)=>a.date.localeCompare(b.date)).map(t=>`<div class="todo-item"><div class="todo-title">${t.title}</div><div class="todo-meta">${new Date(t.date).toLocaleDateString()}</div></div>`).join('');}
  renderFU(open,$('#fuOpen'));renderFU(pastDue,$('#fuPast'));renderFU(urgent,$('#fuUrgent'));renderFU(thisWeek,$('#fuWeek'));
}

/* ===== Export/Import/Clear ===== */
$('#exportBtn').onclick=()=>{const blob=new Blob([JSON.stringify({clients,appointments,sales,outreach},null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='crm.json';a.click();URL.revokeObjectURL(url);};
$('#importBtn').onclick=()=>$('#importFile').click();
// Import expects a JSON object with {clients:[],appointments:[],sales:[],outreach:[]}
$('#importFile').addEventListener('change',e=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=()=>{try{const d=JSON.parse(reader.result);for(const k of['clients','appointments','sales','outreach']){if(!Array.isArray(d[k])){alert(`Missing \`${k}\` array`);return;}}const rawClients=d.clients;clients=rawClients.map(c=>({id:c.id||uuid(),first:c.first||c.firstName||'',last:c.last||c.lastName||'',email:c.email||'',phone:c.phone||'',notes:c.notes||'',birthday:c.birthday||'',styles:c.styles||(c.style?[c.style]:[]),brands:c.brands||(c.brand?[c.brand]:[]),sizeShirt:c.sizeShirt||'',sizeDress:c.sizeDress||'',sizePant:c.sizePant||'',sizeShoe:c.sizeShoe||'',initialSale:Number(c.initialSale||c.initialSales||0)}));appointments=d.appointments;sales=d.sales.map(s=>({id:s.id||uuid(),clientId:s.clientId||'',amount:Number(s.amount||0),date:s.date||todayStr(),desc:s.description||s.desc||'',appointmentId:s.appointmentId||''}));outreach=d.outreach.map(t=>({id:t.id||uuid(),title:t.title||'',date:t.date||todayStr(),category:t.category||'Follow-up',notes:t.notes||'',status:t.status||'open',clientIds:t.clientIds||[],appointmentId:t.appointmentId||''}));saveData();renderAll();alert('Import complete');}catch(err){alert('Invalid file');}};reader.readAsText(file);});
const clearBtn=$('#clearBtn');
if(clearBtn){
  clearBtn.addEventListener('click',()=>{
    if(confirm('Clear ALL data? This cannot be undone.')){
      clients=[];appointments=[];sales=[];outreach=[];
      localStorage.removeItem('crmData');
      renderAll();
    }
  });
}
/* ===== Render All ===== */function renderAll(){renderClients();renderAppointments();renderSales();renderTodos();renderBirthdays();renderSeasonal();renderDashboard();populateClientSelect('#saleClient');populateApptSelect('#saleAppt');populateClientSelect('#apptClients');populateClientSelect('#todoClients');populateApptSelect('#todoAppt');populateClientFilter('#saleClientFilter');}
renderAll();
</script>
</body>
</html>




